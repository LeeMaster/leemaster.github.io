---
title: CMake 工程构建
date: 2019-10-13 05:51:46
tags:
- CMake
---

C/C++项目工程构建工具，CMake学习

<!--more-->

# 再谈构建

工作期间，主要使用的语言是Java和Golang，Golang这个语言本来包管理就有点小问题，当然现在的mod机制也还挺好用了，不过还是Java更容易通俗和易懂，关于构建这个问题在开始工作之后，我每次都有新的体会和学习。

构建是什么，我现在可以给出一个我的理解，我认为的构建是，将源代码按照某种方式进行构建输出成目标产物的过程就是构建。

对于Java来说，构建目标物是jar文件或者war文件，那么源代码自然就是一堆java文件和一些xml文件，统一进行打包。这里面涉及到jar包的规范，也就是所谓的ABI规范。

## ABI 

ABI 应用二进制接口，这个概念用到Java上其实就是JVM加载Jar包中java类的方式。此处不详细展开，那么对于C/C++工程来说，何为ABI，可以简单理解为编译后生成的汇编，不同的计算机体系结构有不同的内存排列方式（大小端）当然也有不同的寄存器规范，比如我们可以随便的用eax但是不一定能随便的用eip之类的指针寄存器，OK，那么编译产物就是符合这个规范的二进制文件。

## 编译目标和编译单元

在Java中编译目标是class文件，编译单元是java文件，如果学过编译原理，我们可以认为一个编译单元中，符号表是可以被完整构建的，只有符号表完整，语义才能完整。那么多个class文件一起被JVM载入内存，那么就会在内存上形成ABI规范。对于C/C++来说，每一个源码文件就是一个编译单元。


# 开始Cmake之旅

## 二进制目标 

在C/C++ 中二进制目标有两种：

* 可执行二进制文件（e.g. ELF 格式）
* 库二进制文件 （e.g. *.so *.a) 

所以我们在使用cmake时首先就需要定义什么是我们的目标，只有目标清晰，才能拆解并完成目标，涉及的指令：

```cmake 
add_library(archive archive.cpp zip.cpp lzma.cpp)
add_executable(zipapp zipapp.cpp)
```

## C/C++ 目标的构建过程

对于初学者来说，很难分清楚，什么是编译，什么是链接，对于编译我们可以认为是生成和地址无关的代码，链接是真的分配内存的时刻。

那么一个二进制目标，为了工程化，自然会被拆解成多个编译单元，从而形成多个编译产物，最后统一链接，就会生成一个库或者一个可执行文件。

所以 

```cmake
target_link_libraries(zipapp archive) # 语义 为了生成 zipapp 我们需要 链接 archive
```


